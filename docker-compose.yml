version: '3.8'

services:
postgres:
image: postgres:16-alpine
container_name: payment-postgres
environment:
POSTGRES_DB: payment_db
POSTGRES_USER: payment_user
POSTGRES_PASSWORD: payment_pass
ports:
- "5432:5432"
volumes:
- postgres_data:/var/lib/postgresql/data
- ./init-db.sql:/docker-entrypoint-initdb.d/init.sql
healthcheck:
test: ["CMD-SHELL", "pg_isready -U payment_user -d payment_db"]
interval: 10s
timeout: 5s
retries: 5
networks:
- payment-network

prometheus:
image: prom/prometheus:latest
container_name: payment-prometheus
ports:
- "9090:9090"
volumes:
- ./docker/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
- prometheus_data:/prometheus
command:
- '--config.file=/etc/prometheus/prometheus.yml'
- '--storage.tsdb.path=/prometheus'
- '--web.console.libraries=/etc/prometheus/console_libraries'
- '--web.console.templates=/etc/prometheus/consoles'
- '--storage.tsdb.retention.time=200h'
- '--web.enable-lifecycle'
networks:
- payment-network

grafana:
image: grafana/grafana:latest
container_name: payment-grafana
ports:
- "3000:3000"
environment:
- GF_SECURITY_ADMIN_PASSWORD=admin
- GF_USERS_ALLOW_SIGN_UP=false
volumes:
- grafana_data:/var/lib/grafana
- ./docker/grafana/provisioning:/etc/grafana/provisioning
depends_on:
- prometheus
networks:
- payment-network

payment-service:
build: .
container_name: payment-service
ports:
- "8080:8080"
environment:
SPRING_PROFILES_ACTIVE: docker
DB_HOST: postgres
DB_PORT: 5432
DB_NAME: payment_db
DB_USER: payment_user
DB_PASSWORD: payment_pass
depends_on:
postgres:
condition: service_healthy
networks:
- payment-network
healthcheck:
test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
interval: 30s
timeout: 10s
retries: 3

volumes:
postgres_data:
prometheus_data:
grafana_data:

networks:
payment-network:
driver: bridge
